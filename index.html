<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Depuraci√≥n de Iframe Monday</title>
    <script src="https://cdn.jsdelivr.net/npm/monday-sdk-js/dist/monday-sdk.min.js"></script>
    <style>
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow: hidden;
        font-family: sans-serif;
      }
      #mensaje {
        padding: 1em;
        font-size: 16px;
        color: #333;
      }
      iframe {
        width: 100%;
        height: 100%;
        border: none;
      }
    </style>
  </head>
  <body>
    <div id="mensaje">‚åõ Esperando contexto de monday...</div>
    <iframe id="iframe" style="display: none;"></iframe>

    <script>
      const monday = window.mondaySdk();
      const mensaje = document.getElementById("mensaje");
      const iframe = document.getElementById("iframe");

      function logAndShow(text, data = null) {
        console.log(text, data);
        mensaje.innerText = text + (data ? `\n\n${JSON.stringify(data, null, 2)}` : '');
      }

      // Escuchar contexto desde monday
      monday.listen("context", async (res) => {
        logAndShow("üì¶ Contexto recibido:", res.data);

        const itemId = res.data?.itemId;
        const boardId = res.data?.boardId;

        if (!itemId || !boardId) {
          logAndShow("‚ùå No se pudo obtener itemId o boardId del contexto.", res.data);
          return;
        }

        // Obtener la URL desde la columna
        try {
          const response = await monday.api(`
            query {
              items(ids: ${itemId}) {
                column_values(ids: ["text_mknys7ye"]) {
                  id
                  text
                }
              }
            }
          `);

          console.log("üîç Resultado API:", response);

          const url = response.data?.items?.[0]?.column_values?.[0]?.text;

          if (url) {
            logAndShow(`‚úÖ URL encontrada: ${url}`);
            iframe.src = url;
            iframe.style.display = "block";
            mensaje.style.display = "none";
          } else {
            logAndShow("‚ö†Ô∏è No se encontr√≥ una URL en la columna especificada.");
          }
        } catch (error) {
          logAndShow("‚ùå Error al ejecutar la consulta a monday.api()", error);
        }
      });
    </script>
  </body>
</html>
